var cov_yrwxtms27=function(){var path="/Users/adriaarki/bootcamp/collab/skylab-bootcamp-201907/staff/adria-arquimbau/KTBO/ktbo-api/logic/order/place-order/index.js";var hash="12c98ca335c464450e466b1b1faf3b007eb876cf";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"/Users/adriaarki/bootcamp/collab/skylab-bootcamp-201907/staff/adria-arquimbau/KTBO/ktbo-api/logic/order/place-order/index.js",statementMap:{"0":{start:{line:8,column:4},end:{line:8,column:24}},"1":{start:{line:11,column:4},end:{line:11,column:25}},"2":{start:{line:25,column:0},end:{line:80,column:1}},"3":{start:{line:27,column:4},end:{line:27,column:37}},"4":{start:{line:29,column:4},end:{line:79,column:8}},"5":{start:{line:31,column:21},end:{line:31,column:48}},"6":{start:{line:33,column:8},end:{line:33,column:71}},"7":{start:{line:33,column:19},end:{line:33,column:71}},"8":{start:{line:35,column:21},end:{line:35,column:30}},"9":{start:{line:37,column:8},end:{line:37,column:68}},"10":{start:{line:37,column:31},end:{line:37,column:68}},"11":{start:{line:39,column:19},end:{line:39,column:29}},"12":{start:{line:41,column:8},end:{line:41,column:30}},"13":{start:{line:42,column:12},end:{line:75,column:13}},"14":{start:{line:44,column:39},end:{line:44,column:117}},"15":{start:{line:44,column:82},end:{line:44,column:115}},"16":{start:{line:45,column:16},end:{line:60,column:18}},"17":{start:{line:48,column:32},end:{line:51,column:22}},"18":{start:{line:50,column:24},end:{line:50,column:76}},"19":{start:{line:52,column:20},end:{line:59,column:21}},"20":{start:{line:54,column:24},end:{line:54,column:75}},"21":{start:{line:57,column:24},end:{line:57,column:108}},"22":{start:{line:61,column:16},end:{line:61,column:79}},"23":{start:{line:61,column:63},end:{line:61,column:77}},"24":{start:{line:62,column:30},end:{line:66,column:18}},"25":{start:{line:68,column:16},end:{line:68,column:37}},"26":{start:{line:69,column:16},end:{line:69,column:33}},"27":{start:{line:71,column:16},end:{line:71,column:28}},"28":{start:{line:74,column:16},end:{line:74,column:36}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:25,column:17},end:{line:25,column:18}},loc:{start:{line:25,column:35},end:{line:80,column:1}},line:25},"1":{name:"(anonymous_1)",decl:{start:{line:29,column:12},end:{line:29,column:13}},loc:{start:{line:29,column:24},end:{line:79,column:5}},line:29},"2":{name:"(anonymous_2)",decl:{start:{line:44,column:71},end:{line:44,column:72}},loc:{start:{line:44,column:82},end:{line:44,column:115}},line:44},"3":{name:"(anonymous_3)",decl:{start:{line:45,column:31},end:{line:45,column:32}},loc:{start:{line:45,column:46},end:{line:60,column:17}},line:45},"4":{name:"(anonymous_4)",decl:{start:{line:48,column:56},end:{line:48,column:57}},loc:{start:{line:48,column:67},end:{line:51,column:21}},line:48},"5":{name:"(anonymous_5)",decl:{start:{line:61,column:52},end:{line:61,column:53}},loc:{start:{line:61,column:63},end:{line:61,column:77}},line:61}},branchMap:{"0":{loc:{start:{line:33,column:8},end:{line:33,column:71}},type:"if",locations:[{start:{line:33,column:8},end:{line:33,column:71}},{start:{line:33,column:8},end:{line:33,column:71}}],line:33},"1":{loc:{start:{line:37,column:8},end:{line:37,column:68}},type:"if",locations:[{start:{line:37,column:8},end:{line:37,column:68}},{start:{line:37,column:8},end:{line:37,column:68}}],line:37},"2":{loc:{start:{line:52,column:20},end:{line:59,column:21}},type:"if",locations:[{start:{line:52,column:20},end:{line:59,column:21}},{start:{line:52,column:20},end:{line:59,column:21}}],line:52}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0},b:{"0":[0,0],"1":[0,0],"2":[0,0]},_coverageSchema:"43e27e138ebf9cfc5966b082cf9a028302ed4184",hash:"12c98ca335c464450e466b1b1faf3b007eb876cf"};var coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}return coverage[path]=coverageData;}();const{models:{Article,User,Order,Item}}=(cov_yrwxtms27.s[0]++,require('ktbo-data'));const{validate}=(cov_yrwxtms27.s[1]++,require('ktbo-utils'));/**
 * 
 * @param {*} ref 
 * @param {*} title 
 * @param {*} description 
 * @param {*} img 
 * @param {*} quantity 
 * @param {*} category 
 * 
 * @returns {Promise}
 */cov_yrwxtms27.s[2]++;module.exports=function(userId){cov_yrwxtms27.f[0]++;cov_yrwxtms27.s[3]++;validate.string(userId,'userId');cov_yrwxtms27.s[4]++;return(async()=>{cov_yrwxtms27.f[1]++;const user=(cov_yrwxtms27.s[5]++,await User.findById(userId));cov_yrwxtms27.s[6]++;if(!user){cov_yrwxtms27.b[0][0]++;cov_yrwxtms27.s[7]++;throw Error(`User with id ${userId} does not exist`);}else{cov_yrwxtms27.b[0][1]++;}const cart=(cov_yrwxtms27.s[8]++,user.cart);cov_yrwxtms27.s[9]++;if(cart.length===0){cov_yrwxtms27.b[1][0]++;cov_yrwxtms27.s[10]++;throw new Error(`Your cart is empty`);}else{cov_yrwxtms27.b[1][1]++;}let date=(cov_yrwxtms27.s[11]++,new Date());cov_yrwxtms27.s[12]++;date=date.toString();cov_yrwxtms27.s[13]++;try{const stockArticles=(cov_yrwxtms27.s[14]++,await Promise.all(user.cart.map(element=>{cov_yrwxtms27.f[2]++;cov_yrwxtms27.s[15]++;return Article.findById(element.article);})));cov_yrwxtms27.s[16]++;user.cart.map(cartArticle=>{cov_yrwxtms27.f[3]++;let index=(cov_yrwxtms27.s[17]++,stockArticles.findIndex(article=>{cov_yrwxtms27.f[4]++;cov_yrwxtms27.s[18]++;return article.id===cartArticle.article.toString();}));cov_yrwxtms27.s[19]++;if(cartArticle.quantity>stockArticles[index].quantity){cov_yrwxtms27.b[2][0]++;cov_yrwxtms27.s[20]++;throw Error('Stock greater than quantity required');}else{cov_yrwxtms27.b[2][1]++;cov_yrwxtms27.s[21]++;stockArticles[index].quantity=stockArticles[index].quantity-cartArticle.quantity;}});cov_yrwxtms27.s[22]++;await Promise.all(stockArticles.map(article=>{cov_yrwxtms27.f[5]++;cov_yrwxtms27.s[23]++;return article.save();}));const order=(cov_yrwxtms27.s[24]++,await Order.create({date,owner:userId,items:user.cart}));cov_yrwxtms27.s[25]++;user.cart=undefined;cov_yrwxtms27.s[26]++;await user.save();cov_yrwxtms27.s[27]++;return order;}catch({message}){cov_yrwxtms27.s[28]++;throw Error(message);}})();};